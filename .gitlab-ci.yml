stages:
  - mirror

# Job pour synchroniser automatiquement vers GitHub
mirror_to_github:
  stage: mirror
  image: bitnami/git:latest
  
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  
  before_script:
    # Configure Git
    - git config --global user.email "gitlab-ci@saas-planz.com"
    - git config --global user.name "GitLab CI Bot"
  
  script:
    # V√©rifier que les variables sont d√©finies
    - |
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "‚ùå ERROR: GITHUB_TOKEN variable is not set"
        exit 1
      fi
    - |
      if [ -z "$GITHUB_USERNAME" ]; then
        echo "‚ùå ERROR: GITHUB_USERNAME variable is not set"
        exit 1
      fi
    - |
      if [ -z "$GITHUB_REPO" ]; then
        echo "‚ùå ERROR: GITHUB_REPO variable is not set"
        exit 1
      fi
    
    - echo "‚úÖ All variables are set"
    - echo "üì¶ Preparing to mirror to github.com/${GITHUB_USERNAME}/${GITHUB_REPO}"
    
    # Ajouter le remote GitHub
    - git remote add github "https://${GITHUB_TOKEN}@github.com/${GITHUB_USERNAME}/${GITHUB_REPO}.git" 2>/dev/null || git remote set-url github "https://${GITHUB_TOKEN}@github.com/${GITHUB_USERNAME}/${GITHUB_REPO}.git"
    
    # Push vers GitHub
    - echo "üöÄ Pushing to GitHub..."
    - git push github HEAD:main --force
    
    # Push les tags (optionnel)
    - echo "üè∑Ô∏è Pushing tags..."
    - git push github --tags --force || echo "‚ö†Ô∏è No tags to push"
    
    - echo "‚úÖ Mirror sync completed successfully!"
  
  only:
    - main
  
  # Retry en cas d'√©chec r√©seau
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Job optionnel: V√©rifier que le miroir est √† jour
verify_mirror:
  stage: mirror
  image: alpine:latest
  
  script:
    - echo "‚úÖ Mirror sync completed successfully"
    - echo "üìç GitHub repo should now be up to date at https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}"
  
  only:
    - main
  
  when: on_success
  needs: ["mirror_to_github"]
